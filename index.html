<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4f46e5">
  <meta name="description" content="–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á—ë—Ç–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
  <title>–£—á—ë—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #f0f5ff;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --text-muted: #9ca3af;
      --border-color: #e5e7eb;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --accent-orange: #f59e0b;
      --shadow-color: rgba(0,0,0,0.1);
    }
    
    .dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border-color: #475569;
      --shadow-color: rgba(0,0,0,0.3);
    }
    
    html { -webkit-text-size-adjust: 100%; }
    body { 
      background: var(--bg-primary); 
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }
    .card { 
      background: var(--bg-secondary); 
      border: 1px solid var(--border-color);
    }
    .input-field {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
    }
    .input-field:focus {
      border-color: var(--accent-blue);
      outline: none;
    }
    .input-field::placeholder { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .bg-tertiary { background: var(--bg-tertiary); }
    .border-custom { border-color: var(--border-color); }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    
    /* PWA Install Banner */
    .install-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Month Comparison */
    .comparison-item {
      transition: all 0.2s ease;
    }
    .comparison-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="min-h-screen p-2 sm:p-4 md:p-6 transition-colors">
  <!-- PWA Install Banner -->
  <div id="install-banner" class="hidden fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-80 install-banner text-white p-4 rounded-2xl shadow-2xl z-50 animate-fade-in">
    <div class="flex items-center gap-3">
      <span class="text-3xl">üì≤</span>
      <div class="flex-1">
        <div class="font-bold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
        <div class="text-sm opacity-90">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω!</div>
      </div>
      <button onclick="installPWA()" class="bg-white text-purple-600 px-4 py-2 rounded-xl font-bold text-sm">–î–∞</button>
      <button onclick="dismissInstall()" class="text-white/70 hover:text-white">‚úï</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 z-50 hidden animate-fade-in">
    <div class="card rounded-xl shadow-xl p-4 max-w-sm flex items-center gap-3">
      <span id="toast-icon" class="text-2xl">‚ÑπÔ∏è</span>
      <div>
        <div id="toast-message" class="font-medium"></div>
        <div id="toast-time" class="text-xs text-muted"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="card rounded-3xl p-6 sm:p-8 w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fade-in">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <button onclick="closeSettings()" class="text-2xl hover:opacity-70">‚úï</button>
      </div>
      
      <div class="space-y-6">
        <!-- Theme -->
        <div>
          <label class="block font-semibold mb-2">üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
          <div class="flex gap-2">
            <button onclick="setTheme('light')" id="theme-light-btn" class="flex-1 p-3 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-semibold">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
            <button onclick="setTheme('dark')" id="theme-dark-btn" class="flex-1 p-3 rounded-xl border-2 border-gray-300 font-semibold">üåô –¢—ë–º–Ω–∞—è</button>
            <button onclick="setTheme('auto')" id="theme-auto-btn" class="flex-1 p-3 rounded-xl border-2 border-gray-300 font-semibold">üîÑ –ê–≤—Ç–æ</button>
          </div>
        </div>
        
        <!-- Cloud Sync (Optional) -->
        <div>
          <label class="block font-semibold mb-2">‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <p class="text-sm text-muted mb-3">–î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.</p>
          <div class="space-y-3">
            <input type="text" id="gh-owner" placeholder="GitHub username" class="input-field w-full p-3 rounded-xl">
            <input type="text" id="gh-repo" placeholder="Repository name" class="input-field w-full p-3 rounded-xl">
            <input type="password" id="gh-token" placeholder="Personal Access Token (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="input-field w-full p-3 rounded-xl">
            <p class="text-xs text-muted">‚ö†Ô∏è –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
          </div>
        </div>
        
        <!-- Data Management -->
        <div>
          <label class="block font-semibold mb-2">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</label>
          <div class="flex flex-wrap gap-2">
            <button onclick="manualCloudSync()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-xl font-semibold">‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="exportData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button onclick="document.getElementById('import-file').click()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-semibold">üì• –ò–º–ø–æ—Ä—Ç</button>
            <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
            <button onclick="confirmClearData()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
          </div>
        </div>
        
        <button onclick="saveSettings()" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-4 rounded-2xl text-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold">üí∞ –£—á—ë—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
      <div class="flex items-center gap-2">
        <button onclick="toggleTheme()" id="theme-toggle" class="card p-3 rounded-xl hover:opacity-80 transition-opacity" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
        <button onclick="openSettings()" class="card p-3 rounded-xl hover:opacity-80 transition-opacity" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- Date & Time -->
    <div class="card rounded-2xl p-4 mb-4 text-center max-w-md mx-auto">
      <div id="current-date" class="text-xl font-bold">‚Äî</div>
      <div id="current-time" class="text-lg font-mono text-blue-500">‚Äî</div>
    </div>

    <!-- Navigation Tabs -->
    <div class="card rounded-2xl p-1 mb-4 flex flex-wrap gap-1">
      <button onclick="showTab('dashboard')" data-tab="dashboard" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all bg-blue-500 text-white">üìä –î–∞—à–±–æ—Ä–¥</button>
      <button onclick="showTab('transactions')" data-tab="transactions" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üìã –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
      <button onclick="showTab('recurring')" data-tab="recurring" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ</button>
      <button onclick="showTab('debts')" data-tab="debts" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üí≥ –î–æ–ª–≥–∏</button>
      <button onclick="showTab('goals')" data-tab="goals" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üê∑ –¶–µ–ª–∏</button>
      <button onclick="showTab('accounts')" data-tab="accounts" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üè¶ –°—á–µ—Ç–∞</button>
      <button onclick="showTab('analytics')" data-tab="analytics" class="tab-btn flex-1 min-w-[120px] py-3 px-4 rounded-xl font-semibold transition-all text-secondary hover:bg-tertiary">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content">
      <!-- Summary Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4">
        <div class="card rounded-2xl p-4 sm:p-6 text-center">
          <div class="text-2xl sm:text-3xl font-bold text-green-500" id="summary-income">0</div>
          <div class="text-sm text-secondary">–î–æ—Ö–æ–¥—ã</div>
          <div class="text-xs mt-1" id="summary-income-change">vs –ø—Ä–æ—à–ª—ã–π: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6 text-center">
          <div class="text-2xl sm:text-3xl font-bold text-red-500" id="summary-expenses">0</div>
          <div class="text-sm text-secondary">–†–∞—Å—Ö–æ–¥—ã</div>
          <div class="text-xs mt-1" id="summary-expenses-change">vs –ø—Ä–æ—à–ª—ã–π: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6 text-center">
          <div class="text-2xl sm:text-3xl font-bold text-blue-500" id="summary-balance">0</div>
          <div class="text-sm text-secondary">–ë–∞–ª–∞–Ω—Å</div>
          <div class="text-xs mt-1" id="summary-balance-change">vs –ø—Ä–æ—à–ª—ã–π: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6 text-center">
          <div class="text-2xl sm:text-3xl font-bold text-orange-500" id="summary-debts">0</div>
          <div class="text-sm text-secondary">–î–æ–ª–≥–∏</div>
          <div class="text-xs mt-1" id="summary-debts-change">vs –ø—Ä–æ—à–ª—ã–π: ‚Äî</div>
          <div class="text-xs mt-1 text-secondary" id="summary-debts-monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ: ‚Äî</div>
        </div>
      </div>

      <!-- Quick Add -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4">‚ö° –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
        <form id="quick-add-form" class="flex flex-wrap gap-3">
          <select id="quick-type" class="input-field p-3 rounded-xl flex-1 min-w-[120px]" required>
            <option value="expense">üí∏ –†–∞—Å—Ö–æ–¥</option>
            <option value="income">üíµ –î–æ—Ö–æ–¥</option>
          </select>
          <select id="quick-category" class="input-field p-3 rounded-xl flex-1 min-w-[120px]" required></select>
          <input type="number" id="quick-amount" placeholder="–°—É–º–º–∞" class="input-field p-3 rounded-xl w-32" min="0" step="0.01" required>
          <input type="text" id="quick-note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="input-field p-3 rounded-xl flex-1 min-w-[150px]">
          <button type="submit" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-6 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
          <canvas id="chart-expenses-pie"></canvas>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–ë–∞–ª–∞–Ω—Å –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
          <canvas id="chart-balance"></canvas>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="font-bold mb-4">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
        <div id="recent-transactions" class="space-y-2"></div>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div id="tab-transactions" class="tab-content hidden">
      <!-- Add Transaction Form -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h3>
        <form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <select id="tx-type" class="input-field p-3 rounded-xl" required>
            <option value="">–¢–∏–ø</option>
            <option value="income">üíµ –î–æ—Ö–æ–¥</option>
            <option value="expense">üí∏ –†–∞—Å—Ö–æ–¥</option>
          </select>
          <select id="tx-category" class="input-field p-3 rounded-xl" required>
            <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
          </select>
          <input type="number" id="tx-amount" placeholder="–°—É–º–º–∞, BYN" class="input-field p-3 rounded-xl" min="0" step="0.01" required>
          <input type="date" id="tx-date" class="input-field p-3 rounded-xl" required>
          <input type="text" id="tx-note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="input-field p-3 rounded-xl sm:col-span-2 lg:col-span-1">
          <button type="submit" class="sm:col-span-2 lg:col-span-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
        </form>
      </div>

      <!-- Search & Filter -->
      <div class="card rounded-2xl p-4 mb-4">
        <div class="flex flex-wrap gap-3">
          <input type="text" id="tx-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..." class="input-field p-3 rounded-xl flex-1 min-w-[200px]" oninput="filterTransactions()">
          <select id="tx-filter-type" class="input-field p-3 rounded-xl" onchange="filterTransactions()">
            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
            <option value="income">–î–æ—Ö–æ–¥—ã</option>
            <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
          </select>
          <select id="tx-filter-month" class="input-field p-3 rounded-xl" onchange="filterTransactions()">
            <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          </select>
          <select id="tx-sort" class="input-field p-3 rounded-xl" onchange="filterTransactions()">
            <option value="date-desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            <option value="date-asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            <option value="amount-desc">–°—É–º–º–∞ ‚Üì</option>
            <option value="amount-asc">–°—É–º–º–∞ ‚Üë</option>
          </select>
        </div>
      </div>

      <!-- Transactions List -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
          <span id="tx-count" class="text-sm text-muted"></span>
        </div>
        <div id="transactions-list" class="space-y-2"></div>
      </div>
    </div>

    <!-- Recurring Tab -->
    <div id="tab-recurring" class="tab-content hidden">
      <!-- Add Recurring -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4">üîÑ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h3>
        <form id="recurring-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <select id="rec-type" class="input-field p-3 rounded-xl" required>
            <option value="">–¢–∏–ø</option>
            <option value="income">üíµ –î–æ—Ö–æ–¥</option>
            <option value="expense">üí∏ –†–∞—Å—Ö–æ–¥</option>
          </select>
          <select id="rec-category" class="input-field p-3 rounded-xl" required>
            <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
          </select>
          <input type="number" id="rec-amount" placeholder="–°—É–º–º–∞, BYN" class="input-field p-3 rounded-xl" min="0" step="0.01" required>
          <input type="text" id="rec-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ó–∞—Ä–ø–ª–∞—Ç–∞)" class="input-field p-3 rounded-xl" required>
          <select id="rec-frequency" class="input-field p-3 rounded-xl" required>
            <option value="">–ß–∞—Å—Ç–æ—Ç–∞</option>
            <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
            <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
            <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
            <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
          </select>
          <input type="date" id="rec-next-date" class="input-field p-3 rounded-xl" required>
          <button type="submit" class="sm:col-span-2 lg:col-span-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
        </form>
      </div>

      <!-- Recurring List -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="font-bold mb-4">–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
        <div id="recurring-list" class="space-y-3"></div>
      </div>
    </div>

    <!-- Debts Tab -->
    <div id="tab-debts" class="tab-content hidden">
      <!-- Add Debt -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4">üí≥ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</h3>
        <form id="debt-form" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <select id="debt-type" class="input-field p-3 rounded-xl" required>
            <option value="">–¢–∏–ø –¥–æ–ª–≥–∞</option>
            <option value="credit">–ö—Ä–µ–¥–∏—Ç</option>
            <option value="installment">–†–∞—Å—Å—Ä–æ—á–∫–∞</option>
          </select>
          <input type="text" id="debt-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="input-field p-3 rounded-xl" required>
          <input type="number" id="debt-total" placeholder="–û–±—â–∞—è —Å—É–º–º–∞" class="input-field p-3 rounded-xl" min="0" step="0.01" required>
          <input type="number" id="debt-monthly" placeholder="–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂" class="input-field p-3 rounded-xl" min="0" step="0.01" required>
          <button type="submit" class="sm:col-span-2 bg-gradient-to-r from-red-500 to-orange-600 text-white font-bold py-3 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</button>
        </form>
      </div>

      <!-- Search & Sort -->
      <div class="card rounded-2xl p-4 mb-4">
        <div class="flex flex-wrap gap-3">
          <input type="text" id="debt-search" placeholder="üîç –ü–æ–∏—Å–∫..." class="input-field p-3 rounded-xl flex-1" oninput="renderDebts()">
          <select id="debt-sort" class="input-field p-3 rounded-xl" onchange="renderDebts()">
            <option value="remaining-desc">–û—Å—Ç–∞—Ç–æ–∫ ‚Üì</option>
            <option value="remaining-asc">–û—Å—Ç–∞—Ç–æ–∫ ‚Üë</option>
            <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            <option value="progress">–ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É</option>
          </select>
        </div>
      </div>

      <!-- Debts List -->
      <div id="debts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Goals Tab -->
    <div id="tab-goals" class="tab-content hidden">
      <!-- Add Goal -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4">üê∑ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</h3>
        <form id="goal-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <input type="text" id="goal-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏" class="input-field p-3 rounded-xl" required>
          <input type="number" id="goal-target" placeholder="–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞" class="input-field p-3 rounded-xl" min="0" step="0.01" required>
          <select id="goal-currency" class="input-field p-3 rounded-xl" required>
            <option value="BYN">BYN</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="RUB">RUB</option>
          </select>
          <button type="submit" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold py-3 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
        </form>
      </div>

      <!-- Search & Sort -->
      <div class="card rounded-2xl p-4 mb-4">
        <div class="flex flex-wrap gap-3">
          <input type="text" id="goal-search" placeholder="üîç –ü–æ–∏—Å–∫..." class="input-field p-3 rounded-xl flex-1" oninput="renderGoals()">
          <select id="goal-sort" class="input-field p-3 rounded-xl" onchange="renderGoals()">
            <option value="progress-desc">–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Üì</option>
            <option value="progress-asc">–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Üë</option>
            <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            <option value="target-desc">–°—É–º–º–∞ ‚Üì</option>
          </select>
        </div>
      </div>

      <!-- Goals List -->
      <div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Accounts Tab -->
    <div id="tab-accounts" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Accounts list -->
        <div class="lg:col-span-2 space-y-4">
          <div class="card rounded-2xl p-4 sm:p-6">
            <div class="flex items-center justify-between gap-3 mb-4">
              <h3 class="font-bold">üè¶ –°—á–µ—Ç–∞ –∏ –∫–æ—à–µ–ª—å–∫–∏</h3>
              <button onclick="seedDefaultAccounts()" class="bg-tertiary hover:opacity-80 px-3 py-2 rounded-xl text-sm font-semibold">+ –ü—Ä–∏–º–µ—Ä—ã</button>
            </div>
            <div id="accounts-summary" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            <div class="mt-4">
              <h4 class="font-bold mb-2">–í—Å–µ —Å—á–µ—Ç–∞</h4>
              <div id="accounts-list" class="space-y-2"></div>
            </div>
          </div>

          <div class="card rounded-2xl p-4 sm:p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold">üìú –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h3>
              <span class="text-sm text-muted" id="transfer-count"></span>
            </div>
            <div id="transfers-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- Add account + transfer -->
        <div class="space-y-4">
          <div class="card rounded-2xl p-4 sm:p-6">
            <h3 class="font-bold mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç</h3>
            <form id="account-form" class="space-y-3">
              <input id="acc-name" type="text" class="input-field w-full p-3 rounded-xl" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ö–∞—Ä—Ç–∞)" required>
              <select id="acc-type" class="input-field w-full p-3 rounded-xl" required>
                <option value="">–¢–∏–ø</option>
                <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                <option value="card">–ö–∞—Ä—Ç–∞</option>
                <option value="deposit">–í–∫–ª–∞–¥</option>
                <option value="metals">–í–∫–ª–∞–¥ –≤ –¥—Ä–∞–≥–º–µ—Ç–∞–ª–ª—ã</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
              </select>

              <!-- –í–∞–ª—é—Ç–∞ —Å—á—ë—Ç–∞ -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <select id="acc-currency" class="input-field w-full p-3 rounded-xl">
                  <option value="BYN">–í–∞–ª—é—Ç–∞: BYN</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="RUB">RUB</option>
                </select>
                <input id="acc-initial" type="number" class="input-field w-full p-3 rounded-xl" min="0" step="0.01" placeholder="–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å">
              </div>

              <!-- –ü–æ–ª—è –¥–ª—è –¥—Ä–∞–≥–º–µ—Ç–∞–ª–ª–æ–≤ -->
              <div id="metals-extra" class="grid grid-cols-1 sm:grid-cols-2 gap-3 hidden">
                <select id="metal-type" class="input-field w-full p-3 rounded-xl">
                  <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
                  <option value="silver">–°–µ—Ä–µ–±—Ä–æ</option>
                </select>
                <input id="metal-grams" type="number" class="input-field w-full p-3 rounded-xl" min="0" step="0.01" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º">
              </div>

              <button type="submit" class="w-full bg-gradient-to-r from-indigo-500 to-blue-600 text-white font-bold py-3 rounded-xl">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
          </div>

          <div class="card rounded-2xl p-4 sm:p-6">
            <h3 class="font-bold mb-4">üîÅ –ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</h3>
            <form id="transfer-form" class="space-y-3">
              <div class="grid grid-cols-1 gap-3">
                <select id="tr-from" class="input-field w-full p-3 rounded-xl" required></select>
                <select id="tr-to" class="input-field w-full p-3 rounded-xl" required></select>
              </div>
              <input id="tr-amount" type="number" class="input-field w-full p-3 rounded-xl" min="0" step="0.01" placeholder="–°—É–º–º–∞ (BYN)" required>
              <input id="tr-date" type="date" class="input-field w-full p-3 rounded-xl" required>
              <input id="tr-note" type="text" class="input-field w-full p-3 rounded-xl" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)">
              <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold py-3 rounded-xl">–°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
              <div class="text-xs text-muted">–ü–µ—Ä–µ–≤–æ–¥—ã –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –¥–æ—Ö–æ–¥–æ–º/—Ä–∞—Å—Ö–æ–¥–æ–º –∏ –Ω–µ –∏—Å–∫–∞–∂–∞—é—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É.</div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics" class="tab-content hidden">
      <!-- Period Selector -->
      <div class="card rounded-2xl p-4 mb-4">
        <div class="flex flex-wrap gap-3 items-center">
          <span class="font-semibold">–ü–µ—Ä–∏–æ–¥:</span>
          <select id="analytics-period" class="input-field p-3 rounded-xl" onchange="renderAnalytics()">
            <option value="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
            <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
            <option value="year">–ì–æ–¥</option>
            <option value="all">–í—Å—ë –≤—Ä–µ–º—è</option>
          </select>
        </div>
      </div>

      <!-- Analytics Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4">
        <div class="card rounded-2xl p-4 text-center">
          <div class="text-2xl font-bold text-green-500" id="analytics-income">0</div>
          <div class="text-sm text-secondary">–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤</div>
          <div class="text-xs mt-1" id="analytics-income-change">vs –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 text-center">
          <div class="text-2xl font-bold text-red-500" id="analytics-expenses">0</div>
          <div class="text-sm text-secondary">–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
          <div class="text-xs mt-1" id="analytics-expenses-change">vs –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 text-center">
          <div class="text-2xl font-bold text-blue-500" id="analytics-avg-income">0</div>
          <div class="text-sm text-secondary">–°—Ä. –¥–æ—Ö–æ–¥/–º–µ—Å</div>
          <div class="text-xs mt-1" id="analytics-avg-income-change">vs –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥: ‚Äî</div>
        </div>
        <div class="card rounded-2xl p-4 text-center">
          <div class="text-2xl font-bold text-orange-500" id="analytics-avg-expense">0</div>
          <div class="text-sm text-secondary">–°—Ä. —Ä–∞—Å—Ö–æ–¥/–º–µ—Å</div>
          <div class="text-xs mt-1" id="analytics-avg-expense-change">vs –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥: ‚Äî</div>
        </div>
      </div>

      <!-- Month-over-Month Comparison -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <h3 class="font-bold mb-4 text-center">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-2">–î–æ—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h4>
            <div id="income-comparison" class="space-y-2"></div>
          </div>
          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-2">–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h4>
            <div id="expense-comparison" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Yearly Report -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <h3 class="font-bold">üìÖ –ì–æ–¥–æ–≤–æ–π –æ—Ç—á—ë—Ç</h3>
          <div class="flex items-center gap-2">
            <span class="text-sm text-secondary">–ì–æ–¥:</span>
            <select id="year-report-year" class="input-field p-2 rounded-xl" onchange="renderYearReport()"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4">
          <div class="bg-tertiary rounded-xl p-4 text-center">
            <div class="text-xl sm:text-2xl font-bold text-green-500" id="year-total-income">0</div>
            <div class="text-xs text-secondary">–î–æ—Ö–æ–¥—ã</div>
          </div>
          <div class="bg-tertiary rounded-xl p-4 text-center">
            <div class="text-xl sm:text-2xl font-bold text-red-500" id="year-total-expenses">0</div>
            <div class="text-xs text-secondary">–†–∞—Å—Ö–æ–¥—ã</div>
          </div>
          <div class="bg-tertiary rounded-xl p-4 text-center">
            <div class="text-xl sm:text-2xl font-bold text-blue-500" id="year-total-balance">0</div>
            <div class="text-xs text-secondary">–ë–∞–ª–∞–Ω—Å</div>
          </div>
          <div class="bg-tertiary rounded-xl p-4 text-center">
            <div class="text-xl sm:text-2xl font-bold text-purple-500" id="year-savings-rate">‚Äî</div>
            <div class="text-xs text-secondary">–ù–æ—Ä–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-3 text-center">–î–æ—Ö–æ–¥—ã / —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h4>
            <canvas id="chart-year-income-expenses"></canvas>
          </div>

          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-3">–ò—Ç–æ–≥–∏ –∏ —Ä–µ–∫–æ—Ä–¥—ã</h4>
            <div id="year-report-highlights" class="space-y-2 text-sm"></div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
              <div>
                <h4 class="font-bold mb-2">–¢–æ–ø —Ä–∞—Å—Ö–æ–¥–æ–≤</h4>
                <div id="year-top-expense-categories" class="space-y-2"></div>
              </div>
              <div>
                <h4 class="font-bold mb-2">–¢–æ–ø –¥–æ—Ö–æ–¥–æ–≤</h4>
                <div id="year-top-income-categories" class="space-y-2"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <h4 class="font-bold mb-3 text-center">–ü–æ–º–µ—Å—è—á–Ω–∞—è —Å–≤–æ–¥–∫–∞</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-secondary border-b border-custom">
                  <th class="py-2 pr-4">–ú–µ—Å—è—Ü</th>
                  <th class="py-2 pr-4">–î–æ—Ö–æ–¥—ã</th>
                  <th class="py-2 pr-4">–†–∞—Å—Ö–æ–¥—ã</th>
                  <th class="py-2">–ë–∞–ª–∞–Ω—Å</th>
                </tr>
              </thead>
              <tbody id="year-report-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- üîÆ Forecasting -->
      <div class="card rounded-2xl p-4 sm:p-6 mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <h3 class="font-bold">üîÆ –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
          <div class="flex items-center gap-2">
            <span class="text-sm text-secondary">–ú–µ—Ç–æ–¥:</span>
            <select id="forecast-method" class="input-field p-2 rounded-xl" onchange="renderForecasting()">
              <option value="pace">–ü–æ —Ç–µ–º–ø—É —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞</option>
              <option value="avg3">–°—Ä–µ–¥–Ω–µ–µ –∑–∞ 3 –º–µ—Å—è—Ü–∞</option>
              <option value="avg6">–°—Ä–µ–¥–Ω–µ–µ –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="bg-tertiary rounded-xl p-4">
            <div class="text-sm text-secondary mb-1">–†–∞—Å—Ö–æ–¥—ã —Å–µ–π—á–∞—Å (MTD)</div>
            <div class="text-2xl font-bold text-red-500" id="forecast-expenses-mtd">‚Äî</div>
            <div class="text-xs text-muted mt-1" id="forecast-days">‚Äî</div>
          </div>

          <div class="bg-tertiary rounded-xl p-4">
            <div class="text-sm text-secondary mb-1">–°–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—á—É –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞?</div>
            <div class="text-2xl font-bold text-orange-500" id="forecast-expenses-eom">‚Äî</div>
            <div class="text-xs mt-1" id="forecast-eom-note">‚Äî</div>
          </div>

          <div class="bg-tertiary rounded-xl p-4">
            <div class="text-sm text-secondary mb-1">–û–∂–∏–¥–∞–µ–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è/–ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ vs —Å—Ä.</div>
            <div class="text-2xl font-bold" id="forecast-delta">‚Äî</div>
            <div class="text-xs text-muted mt-1" id="forecast-delta-note">‚Äî</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-3 text-center">–ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–¥–µ–Ω—å ‚Üí —Å—É–º–º–∞)</h4>
            <canvas id="chart-forecast-expenses"></canvas>
            <div class="text-xs text-muted mt-2">–õ–∏–Ω–∏—è = —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞—Ç—ã –ø–æ –¥–Ω—è–º; –ø—É–Ω–∫—Ç–∏—Ä = –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞.</div>
          </div>

          <div class="bg-tertiary rounded-xl p-4">
            <h4 class="font-bold mb-3">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏</h4>
            <div id="saving-recommendations" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–î–æ—Ö–æ–¥—ã vs –†–∞—Å—Ö–æ–¥—ã</h3>
          <canvas id="chart-income-expenses"></canvas>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–¢—Ä–µ–Ω–¥ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</h3>
          <canvas id="chart-savings-trend"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
          <canvas id="chart-top-categories"></canvas>
        </div>
        <div class="card rounded-2xl p-4 sm:p-6">
          <h3 class="font-bold mb-4 text-center">–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
          <canvas id="chart-income-categories"></canvas>
        </div>
      </div>

      <!-- Detailed Report -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="font-bold mb-4">üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <div id="category-report" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONSTANTS ==========
    const INCOME_CATEGORIES = ['–ó–∞—Ä–ø–ª–∞—Ç–∞', '–§—Ä–∏–ª–∞–Ω—Å', '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', '–ü–æ–¥–∞—Ä–∫–∏', '–í–æ–∑–≤—Ä–∞—Ç', '–î—Ä—É–≥–æ–µ'];
    const EXPENSE_CATEGORIES = ['–ï–¥–∞', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ö—Ä–µ–¥–∏—Ç—ã', '–†–∞—Å—Å—Ä–æ—á–∫–∏', '–ö–æ–º–º—É–Ω–∞–ª–∫–∞', '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–ó–¥–æ—Ä–æ–≤—å–µ', '–û–¥–µ–∂–¥–∞', '–°–≤—è–∑—å', '–î—Ä—É–≥–æ–µ'];
    const CHART_COLORS = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F97316', '#14B8A6', '#6366F1', '#84CC16'];
    
    // ========== STATE ==========
    let data = { transactions: [], goals: [], debts: [], recurring: [], paymentHistory: [], accounts: [], customCategories: { income: [], expense: [] } };
    let charts = {};
    let exchangeRates = { USD: 3.2, EUR: 3.5, RUB: 0.035, CNY: 0.45 };
    let deferredPrompt = null;

    // ========== ACCOUNTS ==========
    const ACCOUNT_TYPES = {
      cash: { label: '–ù–∞–ª–∏—á–Ω—ã–µ', icon: 'üíµ' },
      card: { label: '–ö–∞—Ä—Ç–∞', icon: 'üí≥' },
      deposit: { label: '–í–∫–ª–∞–¥', icon: 'üè¶' },
      metals: { label: '–í–∫–ª–∞–¥ –≤ –¥—Ä–∞–≥–º–µ—Ç–∞–ª–ª—ã', icon: 'ü•á' },
      other: { label: '–î—Ä—É–≥–æ–µ', icon: 'üì¶' }
    };

    function ensureAccounts() {
      if (!Array.isArray(data.accounts)) data.accounts = [];
      // –°–æ–∑–¥–∞—ë–º —Å—á–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
      if (data.accounts.length === 0) {
        data.accounts.push({ id: genId(), name: '–ö–∞—Ä—Ç–∞', type: 'card', initial: 0, currency: 'BYN', createdAt: todayISO() });
        data.accounts.push({ id: genId(), name: '–ù–∞–ª–∏—á–Ω—ã–µ', type: 'cash', initial: 0, currency: 'BYN', createdAt: todayISO() });
      }

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–∞–ª—é—Ç—É –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—á–µ—Ç–æ–≤ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
      (data.accounts || []).forEach(a => {
        if (!a.currency) a.currency = 'BYN';
        a.currency = String(a.currency).toUpperCase();
      });

      // –ù–ï –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫ —Å—á–µ—Ç–∞–º,
      // —Ç.–∫. —ç—Ç–æ –∏—Å–∫–∞–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å. –°—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–±–µ–∑ accountId)
      // –ø—Ä–æ—Å—Ç–æ –Ω–µ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ –±–∞–ª–∞–Ω—Å–µ —Å—á–µ—Ç–æ–≤.
    }

    function getAccountById(id) {
      return (data.accounts || []).find(a => a.id === id);
    }

    function calcAccountBalances() {
      const balances = {};
      (data.accounts || []).forEach(a => {
        balances[a.id] = Number(a.initial) || 0;
      });

      (data.transactions || []).forEach(t => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å—á—ë—Ç—É (—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
        if (t.type === 'income') {
          const accId = t.accountId;
          if (!accId || !balances.hasOwnProperty(accId)) return;
          const amt = Number(t.amount) || 0;
          balances[accId] = (balances[accId] || 0) + amt;
        } else if (t.type === 'expense') {
          const accId = t.accountId;
          if (!accId || !balances.hasOwnProperty(accId)) return;
          const amt = Number(t.amount) || 0;
          balances[accId] = (balances[accId] || 0) - amt;
        } else if (t.type === 'transfer') {
          const amt = Number(t.amount) || 0;
          if (t.fromAccountId && balances.hasOwnProperty(t.fromAccountId)) {
            balances[t.fromAccountId] = (balances[t.fromAccountId] || 0) - amt;
          }
          if (t.toAccountId && balances.hasOwnProperty(t.toAccountId)) {
            balances[t.toAccountId] = (balances[t.toAccountId] || 0) + amt;
          }
        }
      });

      return balances;
    }

    function populateAccountSelects() {
      const fromSel = $('tr-from');
      const toSel = $('tr-to');
      if (!fromSel || !toSel) return;

      const opts = (data.accounts || []).map(a => {
        const meta = ACCOUNT_TYPES[a.type] || ACCOUNT_TYPES.other;
        return `<option value="${a.id}">${meta.icon} ${escapeHtml(a.name)}</option>`;
      }).join('');

      fromSel.innerHTML = '<option value="">–û—Ç–∫—É–¥–∞</option>' + opts;
      toSel.innerHTML = '<option value="">–ö—É–¥–∞</option>' + opts;

      if ((data.accounts || []).length >= 2) {
        fromSel.value = data.accounts[0].id;
        toSel.value = data.accounts[1].id;
      } else if ((data.accounts || []).length === 1) {
        fromSel.value = data.accounts[0].id;
        toSel.value = data.accounts[0].id;
      }
    }

    function seedDefaultAccounts() {
      if ((data.accounts || []).length >= 4) {
        showToast('–ü—Ä–∏–º–µ—Ä—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã', '‚ÑπÔ∏è');
        return;
      }
      const existingNames = new Set((data.accounts || []).map(a => (a.name || '').toLowerCase()));
      const presets = [
        { name: '–ù–∞–ª–∏—á–Ω—ã–µ', type: 'cash' },
        { name: '–ö–∞—Ä—Ç–∞', type: 'card' },
        { name: '–í–∫–ª–∞–¥', type: 'deposit' },
        { name: '–í–∫–ª–∞–¥ –≤ –¥—Ä–∞–≥–º–µ—Ç–∞–ª–ª—ã', type: 'metals' }
      ];
      presets.forEach(p => {
        if (!existingNames.has(p.name.toLowerCase())) {
          data.accounts.push({ id: genId(), name: p.name, type: p.type, initial: 0, currency: 'BYN', createdAt: todayISO() });
        }
      });
      saveData();
      renderAccounts();
      populateAccountSelects();
      showToast('–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Å—á–µ—Ç–æ–≤', '‚úÖ');
    }

    function addAccount(e) {
      e.preventDefault();
      const name = $('acc-name').value.trim();
      const type = $('acc-type').value;
      const initial = parseFloat($('acc-initial').value || '0') || 0;
      const currency = $('acc-currency').value || 'BYN';
      const metalType = $('metal-type')?.value || null;
      const metalGrams = parseFloat($('metal-grams')?.value || '0') || 0;

      if (!name || !type) return;

      const account = { id: genId(), name, type, initial, currency, createdAt: todayISO() };
      if (type === 'metals') {
        account.metalType = metalType;
        account.metalGrams = metalGrams;
      }

      data.accounts.push(account);
      saveData();
      e.target.reset();
      $('metals-extra').classList.add('hidden');
      renderAccounts();
      populateAccountSelects();
      showToast('–°—á—ë—Ç –¥–æ–±–∞–≤–ª–µ–Ω', '‚úÖ');
    }

    function deleteAccount(id) {
      const acc = getAccountById(id);
      if (!acc) return;

      const related = (data.transactions || []).some(t => t.accountId === id || t.fromAccountId === id || t.toAccountId === id);
      const msg = related
        ? `–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç ¬´${acc.name}¬ª? –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö/–ø–µ—Ä–µ–≤–æ–¥–∞—Ö. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï —É–¥–∞–ª—è—Ç—Å—è, –Ω–æ –ø–æ—Ç–µ—Ä—è—é—Ç –ø—Ä–∏–≤—è–∑–∫—É.`
        : `–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç ¬´${acc.name}¬ª?`;

      if (!confirm(msg)) return;

      data.accounts = (data.accounts || []).filter(a => a.id !== id);
      // detach transactions
      (data.transactions || []).forEach(t => {
        if (t.accountId === id) delete t.accountId;
        if (t.fromAccountId === id) delete t.fromAccountId;
        if (t.toAccountId === id) delete t.toAccountId;
      });

      // ensure at least 1 account
      if ((data.accounts || []).length === 0) {
        data.accounts.push({ id: genId(), name: '–ö–∞—Ä—Ç–∞', type: 'card', initial: 0, currency: 'BYN', createdAt: todayISO() });
      }

      saveData();
      renderAccounts();
      populateAccountSelects();
      showToast('–°—á—ë—Ç —É–¥–∞–ª—ë–Ω', 'üóëÔ∏è');
    }

    function addTransfer(e) {
      e.preventDefault();
      const fromAccountId = $('tr-from').value;
      const toAccountId = $('tr-to').value;
      const amount = parseFloat($('tr-amount').value);
      const date = $('tr-date').value;
      const note = $('tr-note').value.trim();

      if (!fromAccountId || !toAccountId || !amount || !date) return;
      if (fromAccountId === toAccountId) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞', '‚ö†Ô∏è');
        return;
      }

      // optional: prevent going negative? We'll allow but warn
      const balances = calcAccountBalances();
      if ((balances[fromAccountId] || 0) < amount) {
        if (!confirm('–ù–∞ —Å—á—ë—Ç–µ-–∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –≤—Å—ë —Ä–∞–≤–Ω–æ?')) return;
      }

      data.transactions.push({
        id: genId(),
        type: 'transfer',
        amount,
        date,
        fromAccountId,
        toAccountId,
        note
      });

      saveData();
      e.target.reset();
      $('tr-date').value = todayISO();
      populateAccountSelects();
      renderAll();
      showToast('–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', '‚úÖ');
    }

    function renderAccounts() {
      const listEl = $('accounts-list');
      const summaryEl = $('accounts-summary');
      const transfersEl = $('transfers-list');
      if (!listEl || !summaryEl || !transfersEl) return;

      ensureAccounts();
      const balances = calcAccountBalances();

      const totalBYN = (data.accounts || []).reduce((s, a) => {
        const cur = String(a.currency || 'BYN').toUpperCase();
        const rate = cur === 'BYN' ? 1 : (exchangeRates[cur] || 1);
        return s + ((balances[a.id] || 0) * rate);
      }, 0);

      summaryEl.innerHTML = `
        <div class="bg-tertiary rounded-xl p-4">
          <div class="text-sm text-secondary">–í—Å–µ–≥–æ –ø–æ –≤—Å–µ–º —Å—á–µ—Ç–∞–º</div>
          <div class="text-2xl font-bold text-blue-500">${fmtBYN(totalBYN)}</div>
          <div class="text-xs text-muted mt-1">‚âà —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –ø–æ –∫—É—Ä—Å–∞–º (BYN)</div>
        </div>
        <div class="bg-tertiary rounded-xl p-4">
          <div class="text-sm text-secondary">–°—á–µ—Ç–æ–≤</div>
          <div class="text-2xl font-bold">${(data.accounts || []).length}</div>
          <div class="text-xs text-muted mt-1">–ù–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç—ã, –≤–∫–ª–∞–¥—ã‚Ä¶</div>
        </div>
      `;

      listEl.innerHTML = (data.accounts || []).map(a => {
        const meta = ACCOUNT_TYPES[a.type] || ACCOUNT_TYPES.other;
        const b = balances[a.id] || 0;
        const cls = b >= 0 ? 'text-green-500' : 'text-red-500';
        const cur = String(a.currency || 'BYN').toUpperCase();
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl bg-tertiary">
            <div class="text-2xl">${meta.icon}</div>
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">${escapeHtml(a.name)}</div>
              <div class="text-xs text-muted">${meta.label} ‚Ä¢ –Ω–∞—á.: ${fmtCurrency(a.initial || 0, cur)}</div>
            </div>
            <div class="font-bold ${cls}">${fmtCurrency(b, cur)}</div>
            <button onclick="deleteAccount('${a.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded-lg">üóëÔ∏è</button>
          </div>
        `;
      }).join('');

      const transfers = (data.transactions || [])
        .filter(t => t.type === 'transfer')
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      $('transfer-count').textContent = `${transfers.length} —à—Ç.`;

      transfersEl.innerHTML = transfers.length === 0
        ? '<div class="text-center text-muted py-6">–ü–µ—Ä–µ–≤–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'
        : transfers.slice(0, 30).map(t => {
          const fromA = getAccountById(t.fromAccountId);
          const toA = getAccountById(t.toAccountId);
          const fromName = fromA ? fromA.name : '‚Äî';
          const toName = toA ? toA.name : '‚Äî';
          return `
            <div class="flex items-center gap-3 p-3 rounded-xl bg-tertiary border-l-4 border-blue-500">
              <div class="text-xl">üîÅ</div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${escapeHtml(fromName)} ‚Üí ${escapeHtml(toName)}</div>
                <div class="text-sm text-muted">${new Date(t.date).toLocaleDateString('ru-RU')}${t.note ? ' ‚Ä¢ ' + escapeHtml(t.note) : ''}</div>
              </div>
              <div class="font-bold text-blue-500">${fmtBYN(t.amount)}</div>
            </div>
          `;
        }).join('');
    }
    
    // ========== UTILITIES ==========
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    const escapeHtml = str => String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    const fmtBYN = n => `${(Number(n)||0).toLocaleString('ru-RU', {maximumFractionDigits:2})} BYN`;
    const fmtCurrency = (n, c) => `${(Number(n)||0).toLocaleString('ru-RU', {maximumFractionDigits:2})} ${c}`;
    const todayISO = () => new Date().toISOString().split('T')[0];
    const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    
    // ========== MONTH COMPARISON ==========
    function getMonthData(year, month) {
      return data.transactions.filter(t => {
        const d = new Date(t.date);
        return d.getFullYear() === year && d.getMonth() === month;
      });
    }
    
    function setChange(elId, current, prev, goodIncrease = true) {
      const delta = current - prev;
      const absDelta = Math.abs(delta);
      const isGood = goodIncrease ? (delta >= 0) : (delta <= 0);
      let pct = 0;
      if (Math.abs(prev) > 0.01) {
        pct = Math.abs((delta / prev) * 100);
      } else if (absDelta > 0.01) {
        pct = Infinity;
      }
      const pctStr = Number.isFinite(pct) ? pct.toFixed(1) : '‚àû';
      const colorClass = isGood ? 'text-green-500' : 'text-red-500';
      const icon = absDelta < 0.01 ? '‚û°Ô∏è' : (isGood ? 'üìà' : 'üìâ');
      $(elId).innerHTML = `vs –ø—Ä–æ—à–ª—ã–π: <span class="font-semibold ${colorClass}">${pctStr}%</span><span class="ml-1">${icon}</span>`;
    }
    
    // ========== THEME ==========
    function getTheme() {
      return localStorage.getItem('theme') || 'auto';
    }
    
    function setTheme(theme) {
      localStorage.setItem('theme', theme);
      applyTheme();
      updateThemeButtons();
    }
    
    function toggleTheme() {
      const current = getTheme();
      const next = current === 'dark' ? 'light' : 'dark';
      setTheme(next);
    }
    
    function applyTheme() {
      const theme = getTheme();
      const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.classList.toggle('dark', isDark);
      $('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      
      // Update chart colors
      Chart.defaults.color = isDark ? '#cbd5e1' : '#4b5563';
      Chart.defaults.borderColor = isDark ? '#475569' : '#e5e7eb';
    }
    
    function updateThemeButtons() {
      const theme = getTheme();
      ['light', 'dark', 'auto'].forEach(t => {
        const btn = $(`theme-${t}-btn`);
        if (btn) {
          btn.classList.toggle('border-blue-500', theme === t);
          btn.classList.toggle('bg-blue-50', theme === t);
          btn.classList.toggle('text-blue-700', theme === t);
          btn.classList.toggle('border-gray-300', theme !== t);
        }
      });
    }
    
    // ========== PWA ==========
    function registerSW() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.warn);
      }
    }
    
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      $('install-banner').classList.remove('hidden');
    });
    
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          $('install-banner').classList.add('hidden');
        });
      }
    }
    
    function dismissInstall() {
      $('install-banner').classList.add('hidden');
    }
    
    // ========== TOAST ==========
    function showToast(message, icon = '‚ÑπÔ∏è') {
      $('toast-message').textContent = message;
      $('toast-icon').textContent = icon;
      $('toast-time').textContent = new Date().toLocaleTimeString('ru-RU');
      $('toast').classList.remove('hidden');
      setTimeout(() => $('toast').classList.add('hidden'), 3000);
    }
    
    // ========== DATA MANAGEMENT ==========
    function parseData(obj) {
      return {
        transactions: Array.isArray(obj?.transactions) ? obj.transactions : [],
        goals: Array.isArray(obj?.goals) ? obj.goals : [],
        debts: Array.isArray(obj?.debts) ? obj.debts : [],
        recurring: Array.isArray(obj?.recurring) ? obj.recurring : [],
        paymentHistory: Array.isArray(obj?.paymentHistory) ? obj.paymentHistory : [],
        accounts: Array.isArray(obj?.accounts) ? obj.accounts : []
      };
    }
    
    function loadData() {
      const saved = localStorage.getItem('financeData');
      if (saved) {
        try {
          data = parseData(JSON.parse(saved));
        } catch (e) {
          console.warn('Failed to parse saved data:', e);
        }
      }
      processRecurring();
    }
    
    async function loadFromCloud() {
      const owner = localStorage.getItem('gh-owner');
      const repo = localStorage.getItem('gh-repo');
      const token = localStorage.getItem('gh-token');
      
      if (!owner || !repo) {
        showToast('GitHub –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—É–∫–∞–∂–∏—Ç–µ owner –∏ repo)', '‚ÑπÔ∏è');
        return false;
      }
      
      // Check if we're online
      if (!navigator.onLine) {
        showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', 'üì°');
        return false;
      }
      
      try {
        showToast('–ó–∞–≥—Ä—É–∑–∫–∞ —Å GitHub...', '‚è≥');
        
        // Use raw.githubusercontent.com for public repos (no CORS issues)
        // or API for private repos with token
        let content;
        
        if (token) {
          // Use GitHub API with token
          const headers = { 
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': `token ${token}`
          };
          
          const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
          
          const res = await fetch(url, { 
            method: 'GET',
            headers,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!res.ok) {
            if (res.status === 404) {
              showToast('–§–∞–π–ª data.json –Ω–µ –Ω–∞–π–¥–µ–Ω', '‚ö†Ô∏è');
            } else if (res.status === 401) {
              showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω', '‚ùå');
            } else if (res.status === 403) {
              showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤', '‚ùå');
            } else {
              showToast(`–û—à–∏–±–∫–∞ GitHub: ${res.status}`, '‚ùå');
            }
            return false;
          }
          
          const fileData = await res.json();
          
          if (!fileData.content) {
            showToast('–§–∞–π–ª –ø—É—Å—Ç–æ–π', '‚ö†Ô∏è');
            return false;
          }
          
          localStorage.setItem('gh-sha', fileData.sha);
          content = decodeURIComponent(escape(atob(fileData.content.replace(/\n/g, ''))));
          
        } else {
          // Use raw.githubusercontent.com for public repos (avoids CORS)
          const url = `https://raw.githubusercontent.com/${owner}/${repo}/main/data.json?t=${Date.now()}`;
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);
          
          const res = await fetch(url, { signal: controller.signal });
          
          clearTimeout(timeoutId);
          
          if (!res.ok) {
            if (res.status === 404) {
              showToast('–§–∞–π–ª data.json –Ω–µ –Ω–∞–π–¥–µ–Ω', '‚ö†Ô∏è');
            } else {
              showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}`, '‚ùå');
            }
            return false;
          }
          
          content = await res.text();
        }
        
        // Parse JSON
        let remoteData;
        try {
          remoteData = JSON.parse(content);
        } catch (parseErr) {
          console.error('JSON parse error:', parseErr);
          showToast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON', '‚ùå');
          return false;
        }
        
        data = parseData(remoteData);
        localStorage.setItem('financeData', JSON.stringify(data));
        
        processRecurring();
        renderAll();
        
        showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å GitHub', '‚úÖ');
        return true;
        
      } catch (e) {
        console.error('Cloud load failed:', e);
        
        if (e.name === 'AbortError') {
          showToast('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è', '‚è±Ô∏è');
        } else if (e.name === 'TypeError') {
          // This usually means network error or CORS issue
          showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (CORS/–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)', 'üåê');
        } else {
          showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '‚ùå');
        }
        return false;
      }
    }
    
    function saveData() {
      localStorage.setItem('financeData', JSON.stringify(data));
      syncToCloud();
    }
    
    function exportData() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `finance-backup-${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'üì§');
    }
    
    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const imported = JSON.parse(reader.result);
          data = {
            transactions: Array.isArray(imported.transactions) ? imported.transactions : [],
            goals: Array.isArray(imported.goals) ? imported.goals : [],
            debts: Array.isArray(imported.debts) ? imported.debts : [],
            recurring: Array.isArray(imported.recurring) ? imported.recurring : [],
            paymentHistory: Array.isArray(imported.paymentHistory) ? imported.paymentHistory : []
          };
          saveData();
          renderAll();
          showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'üì•');
        } catch (err) {
          showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', '‚ùå');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    
    function confirmClearData() {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        data = { transactions: [], goals: [], debts: [], recurring: [], paymentHistory: [] };
        saveData();
        renderAll();
        showToast('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'üóëÔ∏è');
      }
    }
    
    // ========== CLOUD SYNC (Optional) ==========
    async function syncToCloud() {
      const owner = localStorage.getItem('gh-owner');
      const repo = localStorage.getItem('gh-repo');
      const token = localStorage.getItem('gh-token');
      
      if (!owner || !repo || !token) return;
      
      try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        const sha = localStorage.getItem('gh-sha');
        
        const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
          headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json' }
        });
        
        const body = {
          message: `Sync: ${new Date().toLocaleString('ru-RU')}`,
          content,
          branch: 'main'
        };
        
        if (getRes.ok) {
          const fileData = await getRes.json();
          body.sha = fileData.sha;
        }
        
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
      } catch (e) {
        console.warn('Cloud sync failed:', e);
      }
    }
    
    // ========== SETTINGS ==========
    function openSettings() {
      $('gh-owner').value = localStorage.getItem('gh-owner') || '';
      $('gh-repo').value = localStorage.getItem('gh-repo') || '';
      $('gh-token').value = localStorage.getItem('gh-token') || '';
      updateThemeButtons();
      $('settings-modal').classList.remove('hidden');
    }
    
    function closeSettings() {
      $('settings-modal').classList.add('hidden');
    }
    
    function saveSettings() {
      localStorage.setItem('gh-owner', $('gh-owner').value.trim());
      localStorage.setItem('gh-repo', $('gh-repo').value.trim());
      localStorage.setItem('gh-token', $('gh-token').value.trim());
      closeSettings();
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', '‚úÖ');
    }
    
    async function manualCloudSync() {
      const owner = localStorage.getItem('gh-owner');
      const repo = localStorage.getItem('gh-repo');
      
      if (!owner || !repo) {
        showToast('–£–∫–∞–∂–∏—Ç–µ GitHub username –∏ repository –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', '‚ö†Ô∏è');
        return;
      }
      
      await loadFromCloud();
    }
    
    // ========== TABS ==========
    function showTab(tabName) {
      $$('.tab-content').forEach(el => el.classList.add('hidden'));
      $(`tab-${tabName}`).classList.remove('hidden');
      
      $$('.tab-btn').forEach(btn => {
        const isActive = btn.dataset.tab === tabName;
        btn.classList.toggle('bg-blue-500', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('text-secondary', !isActive);
      });
      
      if (tabName === 'analytics') renderAnalytics();
      if (tabName === 'accounts') {
        ensureAccounts();
        populateAccountSelects();
        renderAccounts();
      }
    }
    
    // ========== CLOCK ==========
    function updateClock() {
      const now = new Date();
      const months = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
      $('current-date').textContent = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
      $('current-time').textContent = now.toLocaleTimeString('ru-RU');
    }
    
    // ========== CATEGORIES ==========
    function populateCategories(selectId, type) {
      const select = $(selectId);
      if (!select) return;
      const cats = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
      select.innerHTML = '<option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>' + 
        cats.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // ========== TRANSACTIONS ==========
    function addTransaction(e) {
      e.preventDefault();
      const type = $('tx-type').value;
      const category = $('tx-category').value;
      const amount = parseFloat($('tx-amount').value);
      const date = $('tx-date').value;
      const note = $('tx-note').value.trim();
      
      if (!type || !category || !amount || !date) return;
      
      data.transactions.push({ id: genId(), type, category, amount, date, note });
      saveData();
      e.target.reset();
      $('tx-date').value = todayISO();
      populateCategories('tx-category', '');
      renderAll();
      showToast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', '‚úÖ');
    }
    
    function quickAdd(e) {
      e.preventDefault();
      const type = $('quick-type').value;
      const category = $('quick-category').value;
      const amount = parseFloat($('quick-amount').value);
      const note = $('quick-note').value.trim();
      
      if (!category || !amount) return;
      
      data.transactions.push({ id: genId(), type, category, amount, date: todayISO(), note });
      saveData();
      e.target.reset();
      renderAll();
      showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ', '‚úÖ');
    }
    
    function deleteTransaction(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) return;
      data.transactions = data.transactions.filter(t => t.id !== id);
      saveData();
      renderAll();
    }
    
    function filterTransactions() {
      renderTransactionsList();
    }
    
    function renderTransactionsList() {
      const search = ($('tx-search')?.value || '').toLowerCase();
      const typeFilter = $('tx-filter-type')?.value || '';
      const monthFilter = $('tx-filter-month')?.value || '';
      const sort = $('tx-sort')?.value || 'date-desc';
      
      let filtered = data.transactions.filter(t => {
        if (typeFilter && t.type !== typeFilter) return false;
        if (monthFilter) {
          const tMonth = t.date.substring(0, 7);
          if (tMonth !== monthFilter) return false;
        }
        if (search && !t.category.toLowerCase().includes(search) && !(t.note || '').toLowerCase().includes(search)) return false;
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        switch (sort) {
          case 'date-asc': return new Date(a.date) - new Date(b.date);
          case 'amount-desc': return b.amount - a.amount;
          case 'amount-asc': return a.amount - b.amount;
          default: return new Date(b.date) - new Date(a.date);
        }
      });
      
      $('tx-count').textContent = `${filtered.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π`;
      
      $('transactions-list').innerHTML = filtered.length === 0 
        ? '<div class="text-center text-muted py-8">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>'
        : filtered.map(t => `
          <div class="flex items-center gap-3 p-3 rounded-xl bg-tertiary border-l-4 ${t.type === 'income' ? 'border-green-500' : 'border-red-500'}">
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">${escapeHtml(t.category)}</div>
              <div class="text-sm text-muted">${new Date(t.date).toLocaleDateString('ru-RU')}${t.note ? ' ‚Ä¢ ' + escapeHtml(t.note) : ''}</div>
            </div>
            <div class="font-bold ${t.type === 'income' ? 'text-green-500' : 'text-red-500'}">${t.type === 'income' ? '+' : '-'}${fmtBYN(t.amount)}</div>
            <button onclick="deleteTransaction('${t.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded-lg">üóëÔ∏è</button>
          </div>
        `).join('');
    }
    
    function populateMonthFilter() {
      const months = [...new Set(data.transactions.map(t => t.date.substring(0, 7)))].sort().reverse();
      $('tx-filter-month').innerHTML = '<option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>' +
        months.map(m => {
          const [y, mo] = m.split('-');
          const label = new Date(y, parseInt(mo) - 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
          return `<option value="${m}">${label}</option>`;
        }).join('');
    }
    
    // ========== RECURRING TRANSACTIONS ==========
    function addRecurring(e) {
      e.preventDefault();
      const type = $('rec-type').value;
      const category = $('rec-category').value;
      const amount = parseFloat($('rec-amount').value);
      const name = $('rec-name').value.trim();
      const frequency = $('rec-frequency').value;
      const nextDate = $('rec-next-date').value;
      
      if (!type || !category || !amount || !name || !frequency || !nextDate) return;
      
      data.recurring.push({ id: genId(), type, category, amount, name, frequency, nextDate, active: true });
      saveData();
      e.target.reset();
      $('rec-next-date').value = todayISO();
      renderRecurring();
      showToast('–†–µ–≥—É–ª—è—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', '‚úÖ');
    }
    
    function processRecurring() {
      const today = todayISO();
      let changed = false;
      
      data.recurring.forEach(rec => {
        if (!rec.active) return;
        
        while (rec.nextDate <= today) {
          // Create transaction
          data.transactions.push({
            id: genId(),
            type: rec.type,
            category: rec.category,
            amount: rec.amount,
            date: rec.nextDate,
            note: `üîÑ ${rec.name}`
          });
          
          // Calculate next date
          const d = new Date(rec.nextDate);
          switch (rec.frequency) {
            case 'daily': d.setDate(d.getDate() + 1); break;
            case 'weekly': d.setDate(d.getDate() + 7); break;
            case 'monthly': d.setMonth(d.getMonth() + 1); break;
            case 'yearly': d.setFullYear(d.getFullYear() + 1); break;
          }
          rec.nextDate = d.toISOString().split('T')[0];
          changed = true;
        }
      });
      
      if (changed) saveData();
    }
    
    function deleteRecurring(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) return;
      data.recurring = data.recurring.filter(r => r.id !== id);
      saveData();
      renderRecurring();
    }
    
    function toggleRecurring(id) {
      const rec = data.recurring.find(r => r.id === id);
      if (rec) {
        rec.active = !rec.active;
        saveData();
        renderRecurring();
      }
    }
    
    function renderRecurring() {
      const freqLabels = { daily: '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ', weekly: '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ', monthly: '–ï–∂–µ–º–µ—Å—è—á–Ω–æ', yearly: '–ï–∂–µ–≥–æ–¥–Ω–æ' };
      
      $('recurring-list').innerHTML = data.recurring.length === 0
        ? '<div class="text-center text-muted py-8">–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>'
        : data.recurring.map(r => `
          <div class="card p-4 rounded-xl flex items-center gap-3 ${!r.active ? 'opacity-50' : ''}">
            <div class="text-2xl">${r.type === 'income' ? 'üíµ' : 'üí∏'}</div>
            <div class="flex-1 min-w-0">
              <div class="font-bold truncate">${escapeHtml(r.name)}</div>
              <div class="text-sm text-muted">${r.category} ‚Ä¢ ${freqLabels[r.frequency]}</div>
              <div class="text-xs text-muted">–°–ª–µ–¥—É—é—â–∞—è: ${new Date(r.nextDate).toLocaleDateString('ru-RU')}</div>
            </div>
            <div class="font-bold ${r.type === 'income' ? 'text-green-500' : 'text-red-500'}">${fmtBYN(r.amount)}</div>
            <button onclick="toggleRecurring('${r.id}')" class="p-2 rounded-lg hover:bg-tertiary">${r.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
            <button onclick="deleteRecurring('${r.id}')" class="text-red-500 p-2 rounded-lg hover:bg-red-100">üóëÔ∏è</button>
          </div>
        `).join('');
    }
    
    // ========== DEBTS ==========
    function addDebt(e) {
      e.preventDefault();
      const type = $('debt-type').value;
      const name = $('debt-name').value.trim();
      const total = parseFloat($('debt-total').value);
      const monthly = parseFloat($('debt-monthly').value);
      
      if (!type || !name || !total || !monthly) return;
      
      data.debts.push({ id: genId(), type, name, total, monthly, paid: 0, createdAt: todayISO() });
      saveData();
      e.target.reset();
      renderDebts();
      renderDashboard();
      showToast('–î–æ–ª–≥ –¥–æ–±–∞–≤–ª–µ–Ω', '‚úÖ');
    }
    
    function payDebt(id, amount) {
      const debt = data.debts.find(d => d.id === id);
      if (!debt) return;
      
      const remaining = debt.total - debt.paid;
      const pay = Math.min(remaining, amount);
      if (pay <= 0) return;
      
      debt.paid += pay;
      
      // Add payment to history
      data.paymentHistory.push({
        id: genId(),
        debtId: id,
        debtName: debt.name,
        amount: pay,
        date: todayISO()
      });
      
      // Add as expense transaction
      data.transactions.push({
        id: genId(),
        type: 'expense',
        category: debt.type === 'installment' ? '–†–∞—Å—Å—Ä–æ—á–∫–∏' : '–ö—Ä–µ–¥–∏—Ç—ã',
        amount: pay,
        date: todayISO(),
        note: `–ü–ª–∞—Ç—ë–∂: ${debt.name}`
      });
      
      saveData();
      renderAll();
      showToast(`–û–ø–ª–∞—á–µ–Ω–æ ${fmtBYN(pay)}`, '‚úÖ');
    }
    
    function deleteDebt(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–≥?')) return;
      data.debts = data.debts.filter(d => d.id !== id);
      saveData();
      renderDebts();
      renderDashboard();
    }
    
    function renderDebts() {
      const search = ($('debt-search')?.value || '').toLowerCase();
      const sort = $('debt-sort')?.value || 'remaining-desc';
      
      let filtered = data.debts.filter(d => d.name.toLowerCase().includes(search));
      
      filtered.sort((a, b) => {
        const remA = a.total - a.paid;
        const remB = b.total - b.paid;
        switch (sort) {
          case 'remaining-asc': return remA - remB;
          case 'name': return a.name.localeCompare(b.name);
          case 'progress': return (b.paid / b.total) - (a.paid / a.total);
          default: return remB - remA;
        }
      });
      
      $('debts-list').innerHTML = filtered.length === 0
        ? '<div class="col-span-full text-center text-muted py-8 card rounded-2xl">–ù–µ—Ç –¥–æ–ª–≥–æ–≤</div>'
        : filtered.map(d => {
          const remaining = d.total - d.paid;
          const progress = (d.paid / d.total) * 100;
          const typeLabel = d.type === 'installment' ? '–†–∞—Å—Å—Ä–æ—á–∫–∞' : '–ö—Ä–µ–¥–∏—Ç';
          
          return `
            <div class="card rounded-2xl p-5">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <h4 class="font-bold text-lg">${escapeHtml(d.name)}</h4>
                  <span class="text-xs px-2 py-1 rounded-full ${d.type === 'installment' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${typeLabel}</span>
                </div>
              </div>
              
              <div class="space-y-1 text-sm mb-4">
                <div class="flex justify-between"><span class="text-secondary">–°—É–º–º–∞:</span><span class="font-semibold">${fmtBYN(d.total)}</span></div>
                <div class="flex justify-between"><span class="text-secondary">–û–ø–ª–∞—á–µ–Ω–æ:</span><span class="font-semibold">${fmtBYN(d.paid)}</span></div>
                <div class="flex justify-between"><span class="text-secondary">–û—Å—Ç–∞—Ç–æ–∫:</span><span class="font-bold text-orange-500">${fmtBYN(remaining)}</span></div>
                <div class="flex justify-between"><span class="text-secondary">–ï–∂–µ–º–µ—Å—è—á–Ω–æ:</span><span>${fmtBYN(d.monthly)}</span></div>
              </div>
              
              <div class="mb-4">
                <div class="h-2 bg-tertiary rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-orange-500 to-amber-500 transition-all" style="width: ${Math.min(progress, 100)}%"></div>
                </div>
                <div class="text-xs text-muted mt-1">${progress.toFixed(1)}%</div>
              </div>
              
              <div class="flex gap-2 mb-3">
                <button onclick="payDebt('${d.id}', ${d.monthly})" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-xl font-semibold text-sm">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π</button>
                <button onclick="payDebtCustom('${d.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl font-semibold text-sm">–î—Ä—É–≥–∞—è —Å—É–º–º–∞</button>
              </div>
              
              <button onclick="deleteDebt('${d.id}')" class="w-full bg-red-100 hover:bg-red-200 text-red-600 py-2 rounded-xl font-semibold text-sm">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
        }).join('');
    }
    
    function payDebtCustom(id) {
      const amount = parseFloat(prompt('–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:'));
      if (amount > 0) payDebt(id, amount);
    }
    
    // ========== GOALS ==========
    function addGoal(e) {
      e.preventDefault();
      const name = $('goal-name').value.trim();
      const target = parseFloat($('goal-target').value);
      const currency = $('goal-currency').value;
      
      if (!name || !target) return;
      
      data.goals.push({ id: genId(), name, target, currency, current: 0 });
      saveData();
      e.target.reset();
      renderGoals();
      showToast('–¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞', '‚úÖ');
    }
    
    function addToGoal(id) {
      const amount = parseFloat(prompt('–°—É–º–º–∞:'));
      if (amount > 0) {
        const goal = data.goals.find(g => g.id === id);
        if (goal) {
          goal.current += amount;
          saveData();
          renderGoals();
          showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–ø–∏–ª–∫—É', 'üê∑');
        }
      }
    }
    
    function deleteGoal(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?')) return;
      data.goals = data.goals.filter(g => g.id !== id);
      saveData();
      renderGoals();
    }
    
    function renderGoals() {
      const search = ($('goal-search')?.value || '').toLowerCase();
      const sort = $('goal-sort')?.value || 'progress-desc';
      
      let filtered = data.goals.filter(g => g.name.toLowerCase().includes(search));
      
      filtered.sort((a, b) => {
        const progA = a.current / a.target;
        const progB = b.current / b.target;
        switch (sort) {
          case 'progress-asc': return progA - progB;
          case 'name': return a.name.localeCompare(b.name);
          case 'target-desc': return b.target - a.target;
          default: return progB - progA;
        }
      });
      
      $('goals-list').innerHTML = filtered.length === 0
        ? '<div class="col-span-full text-center text-muted py-8 card rounded-2xl">–ù–µ—Ç —Ü–µ–ª–µ–π</div>'
        : filtered.map(g => {
          const progress = (g.current / g.target) * 100;
          const rate = exchangeRates[g.currency] || 1;
          const targetBYN = g.currency === 'BYN' ? g.target : g.target * rate;
          const currentBYN = g.currency === 'BYN' ? g.current : g.current * rate;
          
          return `
            <div class="card rounded-2xl p-5">
              <div class="flex items-start justify-between mb-3">
                <h4 class="font-bold text-lg">${escapeHtml(g.name)}</h4>
                <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">${g.currency}</span>
              </div>
              
              <div class="mb-4">
                <div class="h-3 bg-tertiary rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-emerald-500 to-green-500 transition-all" style="width: ${Math.min(progress, 100)}%"></div>
                </div>
                <div class="text-sm text-secondary mt-2">${fmtCurrency(g.current, g.currency)} / ${fmtCurrency(g.target, g.currency)}</div>
                <div class="text-xs text-muted">‚âà ${fmtBYN(currentBYN)} / ${fmtBYN(targetBYN)} (${progress.toFixed(1)}%)</div>
              </div>
              
              <div class="flex gap-2">
                <button onclick="addToGoal('${g.id}')" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded-xl font-semibold">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button onclick="deleteGoal('${g.id}')" class="bg-red-100 hover:bg-red-200 text-red-600 py-2 px-4 rounded-xl">üóëÔ∏è</button>
              </div>
            </div>
          `;
        }).join('');
    }
    
    // ========== FORECASTING ==========
    function daysInMonth(d) {
      return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
    }

    function getMonthKey(year, monthIdx) {
      const m = String(monthIdx + 1).padStart(2, '0');
      return `${year}-${m}`;
    }

    function sumExpensesInMonth(year, monthIdx) {
      return data.transactions
        .filter(t => {
          const d = new Date(t.date);
          return !isNaN(d) && t.type === 'expense' && d.getFullYear() === year && d.getMonth() === monthIdx;
        })
        .reduce((s, t) => s + (Number(t.amount) || 0), 0);
    }

    function getMonthlyTotalsRange(countBack) {
      // returns array of last N full months totals (excluding current month)
      const now = new Date();
      const res = [];
      for (let i = 1; i <= countBack; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        res.push({
          year: d.getFullYear(),
          month: d.getMonth(),
          total: sumExpensesInMonth(d.getFullYear(), d.getMonth())
        });
      }
      return res;
    }

    function getDailyExpensesCurrentMonth() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const dim = daysInMonth(now);

      const daily = Array.from({ length: dim }, () => 0);
      data.transactions
        .filter(t => {
          const d = new Date(t.date);
          return !isNaN(d) && t.type === 'expense' && d.getFullYear() === y && d.getMonth() === m;
        })
        .forEach(t => {
          const d = new Date(t.date);
          const idx = d.getDate() - 1;
          if (idx >= 0 && idx < daily.length) daily[idx] += Number(t.amount) || 0;
        });

      return { year: y, month: m, daily, dim };
    }

    function buildRecommendations({ method, mtd, eom, avgBaseline, categoryThisMonth, pacePerDay, remainingDays }) {
      const rec = [];

      // 1) Overall overspend/underspend vs baseline
      if (Number.isFinite(avgBaseline) && avgBaseline > 0.01) {
        const delta = eom - avgBaseline;
        const pct = (delta / avgBaseline) * 100;
        if (delta > 0) {
          rec.push({
            type: 'warn',
            title: '–í–µ—Ä–æ—è—Ç–µ–Ω –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥',
            text: `–ü–æ –ø—Ä–æ–≥–Ω–æ–∑—É (${escapeHtml(method)}) –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ ${fmtBYN(delta)} –±–æ–ª—å—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (${fmtBYN(avgBaseline)}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∏–∑–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ç–µ–º–ø –Ω–∞ ${(Math.max(0, delta) / Math.max(1, remainingDays)).toFixed(2)} BYN/–¥–µ–Ω—å.`
          });
        } else {
          rec.push({
            type: 'ok',
            title: '–•–æ—Ä–æ—à–∏–π —Ç–µ–º–ø',
            text: `–ü–æ –ø—Ä–æ–≥–Ω–æ–∑—É –≤—ã –∏–¥—ë—Ç–µ –Ω–∏–∂–µ/–Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ä–µ–¥–Ω–µ–≥–æ. –ï—Å–ª–∏ —É–¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–º–ø ~${pacePerDay.toFixed(2)} BYN/–¥–µ–Ω—å, –º–µ—Å—è—Ü –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç –æ–∫–æ–ª–æ ${fmtBYN(eom)}.`
          });
        }
      } else {
        rec.push({
          type: 'info',
          title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏',
          text: '–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞—Ç—ã —Ö–æ—Ç—è –±—ã –∑–∞ 3 –º–µ—Å—è—Ü–∞.'
        });
      }

      // 2) Top categories this month
      const topCats = Object.entries(categoryThisMonth)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      if (topCats.length) {
        const topLine = topCats.map(([c, v]) => `${escapeHtml(c)}: ${fmtBYN(v)}`).join(' ‚Ä¢ ');
        rec.push({
          type: 'info',
          title: '–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–µ—Å—è—Ü–∞',
          text: topLine
        });

        // Suggest small cuts
        const biggest = topCats[0];
        if (biggest && biggest[1] > 0) {
          const cut5 = biggest[1] * 0.05;
          rec.push({
            type: 'tip',
            title: `–ò–¥–µ—è: —É—Ä–µ–∑–∞—Ç—å ¬´${escapeHtml(biggest[0])}¬ª –Ω–∞ 5%`,
            text: `–≠—Ç–æ –¥–∞—Å—Ç —ç–∫–æ–Ω–æ–º–∏—é –ø—Ä–∏–º–µ—Ä–Ω–æ ${fmtBYN(cut5)} –∑–∞ –º–µ—Å—è—Ü.`
          });
        }
      } else {
        rec.push({
          type: 'info',
          title: '–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ',
          text: '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–∞—Å—Ö–æ–¥–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –∏ –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ç–∞–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–µ–µ.'
        });
      }

      // 3) Simple habit suggestion if pace is high
      if (pacePerDay > 0 && avgBaseline > 0) {
        const avgPerDay = avgBaseline / 30;
        if (pacePerDay > avgPerDay * 1.25) {
          rec.push({
            type: 'warn',
            title: '–¢–µ–º–ø –≤—ã—à–µ –æ–±—ã—á–Ω–æ–≥–æ',
            text: `–¢–µ–∫—É—â–∏–π —Ç–µ–º–ø ${pacePerDay.toFixed(2)} BYN/–¥–µ–Ω—å –∑–∞–º–µ—Ç–Ω–æ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ ~${avgPerDay.toFixed(2)} BYN/–¥–µ–Ω—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã (—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è/–µ–¥–∞ –≤–Ω–µ –¥–æ–º–∞/–∏–º–ø—É–ª—å—Å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏).`
          });
        }
      }

      return rec;
    }

    function renderForecasting() {
      if (!$('tab-analytics') || $('tab-analytics').classList.contains('hidden')) return;

      const methodKey = $('forecast-method')?.value || 'pace';
      const now = new Date();
      const dayOfMonth = now.getDate();
      const dim = daysInMonth(now);
      const remainingDays = Math.max(0, dim - dayOfMonth);

      const { daily } = getDailyExpensesCurrentMonth();
      const cumulativeActual = [];
      let cum = 0;
      for (let i = 0; i < daily.length; i++) {
        cum += daily[i];
        cumulativeActual.push(cum);
      }

      const mtd = cumulativeActual[dayOfMonth - 1] || 0;
      const pacePerDay = dayOfMonth > 0 ? (mtd / dayOfMonth) : 0;

      // Baseline average for "avg3/avg6"
      const monthsBack = methodKey === 'avg6' ? 6 : 3;
      const hist = getMonthlyTotalsRange(monthsBack);
      const avgBaseline = hist.length ? (hist.reduce((s, x) => s + x.total, 0) / hist.length) : 0;

      // Forecast end-of-month
      let eom;
      let methodLabel;
      if (methodKey === 'pace') {
        eom = pacePerDay * dim;
        methodLabel = '—Ç–µ–º–ø —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞';
      } else {
        eom = avgBaseline; // assume will end around average
        methodLabel = `—Å—Ä–µ–¥–Ω–µ–µ –∑–∞ ${monthsBack} –º–µ—Å.`;
      }

      // Delta vs baseline (for pace method compare to avg; for avg method compare to avg too => 0)
      const delta = eom - avgBaseline;

      // Category breakdown this month
      const y = now.getFullYear();
      const m = now.getMonth();
      const categoryThisMonth = {};
      data.transactions
        .filter(t => {
          const d = new Date(t.date);
          return !isNaN(d) && t.type === 'expense' && d.getFullYear() === y && d.getMonth() === m;
        })
        .forEach(t => {
          categoryThisMonth[t.category] = (categoryThisMonth[t.category] || 0) + (Number(t.amount) || 0);
        });

      // UI text
      if ($('forecast-expenses-mtd')) $('forecast-expenses-mtd').textContent = fmtBYN(mtd);
      if ($('forecast-days')) $('forecast-days').textContent = `–î–µ–Ω—å ${dayOfMonth} –∏–∑ ${dim} ‚Ä¢ –æ—Å—Ç–∞–ª–æ—Å—å ${remainingDays} –¥–Ω. ‚Ä¢ —Ç–µ–º–ø: ${pacePerDay.toFixed(2)} BYN/–¥–µ–Ω—å`;

      if ($('forecast-expenses-eom')) $('forecast-expenses-eom').textContent = fmtBYN(eom);
      if ($('forecast-eom-note')) $('forecast-eom-note').innerHTML = `–û—Ü–µ–Ω–∫–∞ –ø–æ –º–µ—Ç–æ–¥—É: <span class="font-semibold">${escapeHtml(methodLabel)}</span>`;

      const deltaEl = $('forecast-delta');
      const deltaNoteEl = $('forecast-delta-note');
      if (deltaEl && deltaNoteEl) {
        if (avgBaseline <= 0.01) {
          deltaEl.textContent = '‚Äî';
          deltaEl.className = 'text-2xl font-bold text-purple-500';
          deltaNoteEl.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ —Å—Ä–µ–¥–Ω–∏–º.';
        } else {
          const cls = delta <= 0 ? 'text-green-500' : 'text-red-500';
          deltaEl.className = `text-2xl font-bold ${cls}`;
          deltaEl.textContent = `${delta <= 0 ? '-' : '+'}${fmtBYN(Math.abs(delta))}`;
          deltaNoteEl.textContent = `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≤–∞—à–∏–º —Å—Ä–µ–¥–Ω–∏–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${hist.length} –º–µ—Å.: ${fmtBYN(avgBaseline)}.`;
        }
      }

      // Chart: actual cumulative + forecast
      const labels = Array.from({ length: dim }, (_, i) => String(i + 1));
      const predicted = [];
      const lastActual = mtd;
      if (methodKey === 'pace') {
        for (let day = 1; day <= dim; day++) {
          if (day <= dayOfMonth) predicted.push(null);
          else predicted.push(pacePerDay * day);
        }
      } else {
        const avgPerDay = dim > 0 ? (eom / dim) : 0;
        for (let day = 1; day <= dim; day++) {
          if (day <= dayOfMonth) predicted.push(null);
          else predicted.push(avgPerDay * day);
        }
      }

      if (charts.forecastExpenses) charts.forecastExpenses.destroy();
      charts.forecastExpenses = new Chart($('chart-forecast-expenses'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: '–§–∞–∫—Ç (–Ω–∞–∫–æ–ø.)',
              data: cumulativeActual,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.08)',
              fill: true,
              tension: 0.25,
              pointRadius: 0
            },
            {
              label: '–ü—Ä–æ–≥–Ω–æ–∑',
              data: predicted,
              borderColor: '#F59E0B',
              borderDash: [6, 6],
              tension: 0.25,
              pointRadius: 0
            },
            {
              label: '–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ',
              data: labels.map((_, i) => (i + 1 === dayOfMonth ? lastActual : null)),
              borderColor: '#3B82F6',
              pointBackgroundColor: '#3B82F6',
              showLine: false,
              pointRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // Recommendations
      const methodTitle = methodKey === 'pace' ? '–ü–æ —Ç–µ–º–ø—É —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞' : (methodKey === 'avg6' ? '–°—Ä–µ–¥–Ω–µ–µ –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤' : '–°—Ä–µ–¥–Ω–µ–µ –∑–∞ 3 –º–µ—Å—è—Ü–∞');
      const recs = buildRecommendations({
        method: methodTitle,
        mtd,
        eom,
        avgBaseline,
        categoryThisMonth,
        pacePerDay,
        remainingDays
      });

      const typeBadge = (t) => {
        if (t === 'warn') return '<span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">–í–∞–∂–Ω–æ</span>';
        if (t === 'ok') return '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">–û–∫</span>';
        if (t === 'tip') return '<span class="text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">–°–æ–≤–µ—Ç</span>';
        return '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">–ò–Ω—Ñ–æ</span>';
      };

      $('saving-recommendations').innerHTML = recs.map(r => `
        <div class="p-3 rounded-xl bg-white dark:bg-gray-700 flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-semibold">${escapeHtml(r.title)}</div>
            <div class="text-secondary text-sm">${r.text}</div>
          </div>
          <div class="shrink-0">${typeBadge(r.type)}</div>
        </div>
      `).join('');
    }

    // ========== ANALYTICS ==========
    function renderAnalytics() {
      const period = $('analytics-period')?.value || 'month';
      const now = new Date();
      let startDate;
      let prevStartDate;
      let prevEndDate;
      
      switch (period) {
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          prevStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          prevEndDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'quarter':
          startDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
          prevStartDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
          prevEndDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          prevStartDate = new Date(now.getFullYear() - 1, 0, 1);
          prevEndDate = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          startDate = new Date(0);
          prevStartDate = new Date(0);
          prevEndDate = new Date(0);
      }
      
      const filtered = data.transactions.filter(t => new Date(t.date) >= startDate);
      const prevFiltered = data.transactions.filter(t => 
        new Date(t.date) >= prevStartDate && new Date(t.date) < prevEndDate);
      
      const income = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const expenses = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const prevIncome = prevFiltered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const prevExpenses = prevFiltered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      
      const months = Math.max(1, Math.ceil((now - startDate) / (30 * 24 * 60 * 60 * 1000)));
      const prevMonths = Math.max(1, Math.ceil((prevEndDate - prevStartDate) / (30 * 24 * 60 * 60 * 1000)));
      
      const avgIncome = income / months;
      const avgExpenses = expenses / months;
      const prevAvgIncome = prevIncome / prevMonths;
      const prevAvgExpenses = prevExpenses / prevMonths;
      
      $('analytics-income').textContent = fmtBYN(income);
      $('analytics-expenses').textContent = fmtBYN(expenses);
      $('analytics-avg-income').textContent = fmtBYN(avgIncome);
      $('analytics-avg-expense').textContent = fmtBYN(avgExpenses);
      
      // Display period-over-period changes
      setChange('analytics-income-change', income, prevIncome, true);
      setChange('analytics-expenses-change', expenses, prevExpenses, false);
      setChange('analytics-avg-income-change', avgIncome, prevAvgIncome, true);
      setChange('analytics-avg-expense-change', avgExpenses, prevAvgExpenses, false);
      
      renderAnalyticsCharts(filtered);
      renderCategoryReport(filtered);
      renderMonthComparison();
      renderYearReport();
      renderForecasting();
    }
    
    function renderMonthComparison() {
      const now = new Date();
      const months = [];
      
      // Get last 6 months
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({
          year: d.getFullYear(),
          month: d.getMonth(),
          label: d.toLocaleDateString('ru-RU', { month: 'short' })
        });
      }
      
      // Calculate income and expenses for each month
      const incomeData = [];
      const expenseData = [];
      
      months.forEach(m => {
        const monthTransactions = data.transactions.filter(t => {
          const d = new Date(t.date);
          return d.getFullYear() === m.year && d.getMonth() === m.month;
        });
        
        const income = monthTransactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + t.amount, 0);
          
        const expenses = monthTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + t.amount, 0);
          
        incomeData.push(income);
        expenseData.push(expenses);
      });
      
      // Render income comparison
      let incomeHTML = '';
      for (let i = 1; i < months.length; i++) {
        const current = incomeData[i];
        const previous = incomeData[i-1];
        const delta = current - previous;
        const pct = previous > 0 ? ((delta / previous) * 100).toFixed(1) : '‚àû';
        const isPositive = delta >= 0;
        const colorClass = isPositive ? 'text-green-500' : 'text-red-500';
        const icon = isPositive ? '‚ñ≤' : '‚ñº';
        
        incomeHTML += `
          <div class="flex justify-between items-center p-2 rounded-lg bg-white dark:bg-gray-700">
            <span>${months[i].label}</span>
            <div class="flex items-center gap-2">
              <span class="font-medium">${fmtBYN(current)}</span>
              <span class="${colorClass} text-sm flex items-center">
                ${icon} ${Math.abs(pct)}%
              </span>
            </div>
          </div>
        `;
      }
      $('income-comparison').innerHTML = incomeHTML;
      
      // Render expense comparison
      let expenseHTML = '';
      for (let i = 1; i < months.length; i++) {
        const current = expenseData[i];
        const previous = expenseData[i-1];
        const delta = current - previous;
        const pct = previous > 0 ? ((delta / previous) * 100).toFixed(1) : '‚àû';
        const isPositive = delta >= 0;
        const colorClass = isPositive ? 'text-red-500' : 'text-green-500';
        const icon = isPositive ? '‚ñ≤' : '‚ñº';
        
        expenseHTML += `
          <div class="flex justify-between items-center p-2 rounded-lg bg-white dark:bg-gray-700">
            <span>${months[i].label}</span>
            <div class="flex items-center gap-2">
              <span class="font-medium">${fmtBYN(current)}</span>
              <span class="${colorClass} text-sm flex items-center">
                ${icon} ${Math.abs(pct)}%
              </span>
            </div>
          </div>
        `;
      }
      $('expense-comparison').innerHTML = expenseHTML;
    }

    // ========== YEAR REPORT ==========
    function getAvailableYears() {
      const years = new Set();
      data.transactions.forEach(t => {
        const d = new Date(t.date);
        if (!isNaN(d)) years.add(d.getFullYear());
      });
      if (years.size === 0) years.add(new Date().getFullYear());
      return [...years].sort((a, b) => b - a);
    }

    function populateYearReportSelect() {
      const sel = $('year-report-year');
      if (!sel) return;

      const years = getAvailableYears();
      const prev = sel.value ? Number(sel.value) : null;

      sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

      const fallback = new Date().getFullYear();
      const next = (prev && years.includes(prev)) ? prev : (years.includes(fallback) ? fallback : years[0]);
      sel.value = String(next);
    }

    function renderYearReport(forceYear) {
      const sel = $('year-report-year');
      if (!sel) return;

      // Keep year selector up to date
      populateYearReportSelect();

      const year = Number(forceYear || sel.value || new Date().getFullYear());
      sel.value = String(year);

      const monthsShort = Array.from({ length: 12 }, (_, m) =>
        new Date(year, m, 1).toLocaleDateString('ru-RU', { month: 'short' })
      );

      const monthly = Array.from({ length: 12 }, () => ({ income: 0, expense: 0 }));

      const tx = data.transactions.filter(t => {
        const d = new Date(t.date);
        return !isNaN(d) && d.getFullYear() === year;
      });

      tx.forEach(t => {
        const d = new Date(t.date);
        const m = d.getMonth();
        if (m < 0 || m > 11) return;
        if (t.type === 'income') monthly[m].income += Number(t.amount) || 0;
        else if (t.type === 'expense') monthly[m].expense += Number(t.amount) || 0;
      });

      const incomeByMonth = monthly.map(m => m.income);
      const expenseByMonth = monthly.map(m => m.expense);
      const balanceByMonth = monthly.map(m => m.income - m.expense);

      const totalIncome = incomeByMonth.reduce((a, b) => a + b, 0);
      const totalExpense = expenseByMonth.reduce((a, b) => a + b, 0);
      const totalBalance = totalIncome - totalExpense;

      // Cards
      $('year-total-income').textContent = fmtBYN(totalIncome);
      $('year-total-expenses').textContent = fmtBYN(totalExpense);
      $('year-total-balance').textContent = fmtBYN(totalBalance);

      const rateEl = $('year-savings-rate');
      if (rateEl) {
        if (Math.abs(totalIncome) < 0.01) {
          rateEl.textContent = '‚Äî';
          rateEl.classList.remove('text-green-500', 'text-red-500');
          rateEl.classList.add('text-purple-500');
        } else {
          const rate = (totalBalance / totalIncome) * 100;
          rateEl.textContent = `${rate.toFixed(1)}%`;
          rateEl.classList.remove('text-purple-500', 'text-green-500', 'text-red-500');
          rateEl.classList.add(rate >= 0 ? 'text-green-500' : 'text-red-500');
        }
      }

      // Top categories
      const sumCats = (type) => {
        const out = {};
        tx.filter(t => t.type === type).forEach(t => {
          out[t.category] = (out[t.category] || 0) + (Number(t.amount) || 0);
        });
        return Object.entries(out).sort((a, b) => b[1] - a[1]);
      };

      const topExpenses = sumCats('expense').slice(0, 5);
      const topIncome = sumCats('income').slice(0, 5);

      $('year-top-expense-categories').innerHTML = topExpenses.length
        ? topExpenses.map(([c, v]) => `
          <div class="flex items-center justify-between p-2 rounded-lg bg-white dark:bg-gray-700">
            <span class="truncate pr-2">${escapeHtml(c)}</span>
            <span class="font-semibold text-red-500">${fmtBYN(v)}</span>
          </div>
        `).join('')
        : '<div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

      $('year-top-income-categories').innerHTML = topIncome.length
        ? topIncome.map(([c, v]) => `
          <div class="flex items-center justify-between p-2 rounded-lg bg-white dark:bg-gray-700">
            <span class="truncate pr-2">${escapeHtml(c)}</span>
            <span class="font-semibold text-green-500">${fmtBYN(v)}</span>
          </div>
        `).join('')
        : '<div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

      // Highlights
      const bestIdx = balanceByMonth.indexOf(Math.max(...balanceByMonth));
      const worstIdx = balanceByMonth.indexOf(Math.min(...balanceByMonth));
      const bestLabel = new Date(year, bestIdx, 1).toLocaleDateString('ru-RU', { month: 'long' });
      const worstLabel = new Date(year, worstIdx, 1).toLocaleDateString('ru-RU', { month: 'long' });

      const biggestIncomeTx = tx.filter(t => t.type === 'income').sort((a, b) => (b.amount || 0) - (a.amount || 0))[0];
      const biggestExpenseTx = tx.filter(t => t.type === 'expense').sort((a, b) => (b.amount || 0) - (a.amount || 0))[0];

      const avgIncome = totalIncome / 12;
      const avgExpense = totalExpense / 12;

      $('year-report-highlights').innerHTML = `
        <div class="flex justify-between gap-3"><span class="text-secondary">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</span><span class="font-semibold">${tx.length}</span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–õ—É—á—à–∏–π –º–µ—Å—è—Ü:</span><span class="font-semibold">${escapeHtml(bestLabel)} ‚Ä¢ <span class="text-green-500">${fmtBYN(balanceByMonth[bestIdx])}</span></span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–•—É–¥—à–∏–π –º–µ—Å—è—Ü:</span><span class="font-semibold">${escapeHtml(worstLabel)} ‚Ä¢ <span class="text-red-500">${fmtBYN(balanceByMonth[worstIdx])}</span></span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥/–º–µ—Å:</span><span class="font-semibold text-green-500">${fmtBYN(avgIncome)}</span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥/–º–µ—Å:</span><span class="font-semibold text-red-500">${fmtBYN(avgExpense)}</span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–ö—Ä—É–ø–Ω–µ–π—à–∏–π –¥–æ—Ö–æ–¥:</span><span class="font-semibold">${biggestIncomeTx ? `${fmtBYN(biggestIncomeTx.amount)} ‚Ä¢ ${escapeHtml(biggestIncomeTx.category)}` : '‚Äî'}</span></div>
        <div class="flex justify-between gap-3"><span class="text-secondary">–ö—Ä—É–ø–Ω–µ–π—à–∏–π —Ä–∞—Å—Ö–æ–¥:</span><span class="font-semibold">${biggestExpenseTx ? `${fmtBYN(biggestExpenseTx.amount)} ‚Ä¢ ${escapeHtml(biggestExpenseTx.category)}` : '‚Äî'}</span></div>
      `;

      // Table
      $('year-report-table').innerHTML = monthly.map((m, idx) => {
        const bal = m.income - m.expense;
        const cls = bal >= 0 ? 'text-green-500' : 'text-red-500';
        const label = new Date(year, idx, 1).toLocaleDateString('ru-RU', { month: 'long' });
        return `
          <tr class="border-b border-custom">
            <td class="py-2 pr-4 whitespace-nowrap">${escapeHtml(label)}</td>
            <td class="py-2 pr-4 text-green-500 font-semibold whitespace-nowrap">${fmtBYN(m.income)}</td>
            <td class="py-2 pr-4 text-red-500 font-semibold whitespace-nowrap">${fmtBYN(m.expense)}</td>
            <td class="py-2 font-bold whitespace-nowrap ${cls}">${fmtBYN(bal)}</td>
          </tr>
        `;
      }).join('');

      // Chart (render only when analytics tab is visible to avoid 0-size canvases)
      if ($('tab-analytics')?.classList.contains('hidden')) return;

      if (charts.yearIncomeExpenses) charts.yearIncomeExpenses.destroy();
      charts.yearIncomeExpenses = new Chart($('chart-year-income-expenses'), {
        type: 'bar',
        data: {
          labels: monthsShort,
          datasets: [
            { label: '–î–æ—Ö–æ–¥—ã', data: incomeByMonth, backgroundColor: '#10B981' },
            { label: '–†–∞—Å—Ö–æ–¥—ã', data: expenseByMonth, backgroundColor: '#EF4444' }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    
    function renderAnalyticsCharts(transactions) {
      // Income vs Expenses by month
      const monthlyData = {};
      transactions.forEach(t => {
        const month = t.date.substring(0, 7);
        if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0 };
        if (t.type === 'income') monthlyData[month].income += t.amount;
        else monthlyData[month].expenses += t.amount;
      });
      
      const months = Object.keys(monthlyData).sort();
      const incomeData = months.map(m => monthlyData[m].income);
      const expenseData = months.map(m => monthlyData[m].expenses);
      const labels = months.map(m => {
        const [y, mo] = m.split('-');
        return new Date(y, parseInt(mo) - 1).toLocaleDateString('ru-RU', { month: 'short' });
      });
      
      if (charts.incomeExpenses) charts.incomeExpenses.destroy();
      charts.incomeExpenses = new Chart($('chart-income-expenses'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '–î–æ—Ö–æ–¥—ã', data: incomeData, backgroundColor: '#10B981' },
            { label: '–†–∞—Å—Ö–æ–¥—ã', data: expenseData, backgroundColor: '#EF4444' }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
      
      // Savings trend
      let cumulative = 0;
      const savingsData = months.map(m => {
        cumulative += monthlyData[m].income - monthlyData[m].expenses;
        return cumulative;
      });
      
      if (charts.savingsTrend) charts.savingsTrend.destroy();
      charts.savingsTrend = new Chart($('chart-savings-trend'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è',
            data: savingsData,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { responsive: true }
      });
      
      // Top expense categories
      const expenseCats = {};
      transactions.filter(t => t.type === 'expense').forEach(t => {
        expenseCats[t.category] = (expenseCats[t.category] || 0) + t.amount;
      });
      
      const sortedCats = Object.entries(expenseCats).sort((a, b) => b[1] - a[1]);
      
      if (charts.topCategories) charts.topCategories.destroy();
      charts.topCategories = new Chart($('chart-top-categories'), {
        type: 'doughnut',
        data: {
          labels: sortedCats.map(([c]) => c),
          datasets: [{ data: sortedCats.map(([, v]) => v), backgroundColor: CHART_COLORS }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Income categories
      const incomeCats = {};
      transactions.filter(t => t.type === 'income').forEach(t => {
        incomeCats[t.category] = (incomeCats[t.category] || 0) + t.amount;
      });
      
      const sortedIncome = Object.entries(incomeCats).sort((a, b) => b[1] - a[1]);
      
      if (charts.incomeCategories) charts.incomeCategories.destroy();
      charts.incomeCategories = new Chart($('chart-income-categories'), {
        type: 'pie',
        data: {
          labels: sortedIncome.map(([c]) => c),
          datasets: [{ data: sortedIncome.map(([, v]) => v), backgroundColor: CHART_COLORS }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
    
    function renderCategoryReport(transactions) {
      const catData = {};
      transactions.forEach(t => {
        const key = `${t.type}-${t.category}`;
        if (!catData[key]) catData[key] = { type: t.type, category: t.category, total: 0, count: 0 };
        catData[key].total += t.amount;
        catData[key].count++;
      });
      
      const sorted = Object.values(catData).sort((a, b) => b.total - a.total);
      
      $('category-report').innerHTML = sorted.length === 0
        ? '<div class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'
        : sorted.map(c => `
          <div class="flex items-center gap-3 p-3 rounded-xl bg-tertiary">
            <div class="text-xl">${c.type === 'income' ? 'üíµ' : 'üí∏'}</div>
            <div class="flex-1">
              <div class="font-semibold">${escapeHtml(c.category)}</div>
              <div class="text-xs text-muted">${c.count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
            </div>
            <div class="font-bold ${c.type === 'income' ? 'text-green-500' : 'text-red-500'}">${fmtBYN(c.total)}</div>
          </div>
        `).join('');
    }
    
    // ========== DASHBOARD ==========
    function renderDashboard() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
      
      // Current month data
      const monthTx = data.transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });
      
      const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const expenses = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const balance = income - expenses;
      const debtsRemaining = data.debts.reduce((s, d) => s + (d.total - d.paid), 0);
      const debtsMonthly = data.debts.reduce((s, d) => s + (Number(d.monthly) || 0), 0);
      
      // Previous month data
      const prevMonthTx = data.transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
      });
      
      const prevIncome = prevMonthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const prevExpenses = prevMonthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const prevBalance = prevIncome - prevExpenses;
      
      // Display current values
      $('summary-income').textContent = fmtBYN(income);
      $('summary-expenses').textContent = fmtBYN(expenses);
      $('summary-balance').textContent = fmtBYN(balance);
      $('summary-debts').textContent = fmtBYN(debtsRemaining);
      if ($('summary-debts-monthly')) {
        $('summary-debts-monthly').textContent = `–ï–∂–µ–º–µ—Å—è—á–Ω–æ: ${fmtBYN(debtsMonthly)}`;
      }
      
      // Display month-over-month changes
      setChange('summary-income-change', income, prevIncome, true);
      setChange('summary-expenses-change', expenses, prevExpenses, false);
      setChange('summary-balance-change', balance, prevBalance, true);
      setChange('summary-debts-change', debtsRemaining, debtsRemaining, true); // Placeholder for debts change
      
      // Recent transactions
      const recent = [...data.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
      $('recent-transactions').innerHTML = recent.length === 0
        ? '<div class="text-center text-muted py-4">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>'
        : recent.map(t => `
          <div class="flex items-center gap-3 p-2 rounded-xl bg-tertiary">
            <div class="text-lg">${t.type === 'income' ? 'üíµ' : 'üí∏'}</div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">${escapeHtml(t.category)}</div>
              <div class="text-xs text-muted">${new Date(t.date).toLocaleDateString('ru-RU')}</div>
            </div>
            <div class="font-bold ${t.type === 'income' ? 'text-green-500' : 'text-red-500'}">${t.type === 'income' ? '+' : '-'}${fmtBYN(t.amount)}</div>
          </div>
        `).join('');
      
      renderDashboardCharts();
    }
    
    function renderDashboardCharts() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Expenses pie
      const monthExpenses = data.transactions.filter(t => {
        const d = new Date(t.date);
        return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });
      
      const catTotals = {};
      monthExpenses.forEach(t => {
        catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
      });
      
      if (charts.expensesPie) charts.expensesPie.destroy();
      charts.expensesPie = new Chart($('chart-expenses-pie'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(catTotals).length ? Object.keys(catTotals) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
          datasets: [{ 
            data: Object.values(catTotals).length ? Object.values(catTotals) : [1], 
            backgroundColor: Object.keys(catTotals).length ? CHART_COLORS : ['#e5e7eb'] 
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
      
      // Balance chart
      const labels = [];
      const balances = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(d.toLocaleDateString('ru-RU', { month: 'short' }));
        
        const monthTx = data.transactions.filter(t => {
          const td = new Date(t.date);
          return td.getMonth() === d.getMonth() && td.getFullYear() === d.getFullYear();
        });
        
        const inc = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const exp = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
        balances.push(inc - exp);
      }
      
      if (charts.balance) charts.balance.destroy();
      charts.balance = new Chart($('chart-balance'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '–ë–∞–ª–∞–Ω—Å', data: balances, backgroundColor: balances.map(b => b >= 0 ? '#10B981' : '#EF4444') }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }
    
    // ========== EXCHANGE RATES ==========
    async function fetchExchangeRates() {
      try {
        const res = await fetch('https://www.nbrb.by/api/exrates/rates?periodicity=0');
        if (!res.ok) throw new Error();
        const rates = await res.json();
        
        rates.forEach(r => {
          if (['USD', 'EUR', 'RUB', 'CNY'].includes(r.Cur_Abbreviation)) {
            exchangeRates[r.Cur_Abbreviation] = r.Cur_OfficialRate / r.Cur_Scale;
          }
        });
      } catch (e) {
        console.warn('Failed to fetch exchange rates');
      }
    }
    
    // ========== RENDER ALL ==========
    function renderAll() {
      ensureAccounts();
      renderDashboard();
      renderTransactionsList();
      renderRecurring();
      renderDebts();
      renderGoals();
      renderAccounts();
      populateAccountSelects();
      populateMonthFilter();
    }
    
    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', async () => {
      // Theme
      applyTheme();
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
      
      // PWA
      registerSW();
      
      // Clock
      updateClock();
      setInterval(updateClock, 1000);
      
      // Set default dates
      $('tx-date').value = todayISO();
      $('rec-next-date').value = todayISO();
      
      // Category selects
      $('tx-type').addEventListener('change', e => populateCategories('tx-category', e.target.value));
      $('rec-type').addEventListener('change', e => populateCategories('rec-category', e.target.value));
      $('quick-type').addEventListener('change', e => populateCategories('quick-category', e.target.value));
      populateCategories('quick-category', 'expense');

      // Toggle metals extra fields
      const accTypeEl = $('acc-type');
      if (accTypeEl) {
        accTypeEl.addEventListener('change', e => {
          const wrap = $('metals-extra');
          if (!wrap) return;
          if (e.target.value === 'metals') {
            wrap.classList.remove('hidden');
          } else {
            wrap.classList.add('hidden');
          }
        });
      }
      
      // Forms
      $('transaction-form').addEventListener('submit', addTransaction);
      $('quick-add-form').addEventListener('submit', quickAdd);
      $('recurring-form').addEventListener('submit', addRecurring);
      $('debt-form').addEventListener('submit', addDebt);
      $('goal-form').addEventListener('submit', addGoal);
      $('account-form')?.addEventListener('submit', addAccount);
      $('transfer-form')?.addEventListener('submit', addTransfer);
      
      // Load data - try cloud first, then local
      const owner = localStorage.getItem('gh-owner');
      const repo = localStorage.getItem('gh-repo');
      const token = localStorage.getItem('gh-token');
      
      if (owner && repo && token) {
        // GitHub configured - load from cloud
        const cloudLoaded = await loadFromCloud();
        if (!cloudLoaded) {
          // Cloud failed, fall back to local
          loadData();
          renderAll();
        }
      } else {
        // No GitHub - load from local storage
        loadData();
        renderAll();
      }
      
      // Exchange rates
      fetchExchangeRates().then(() => renderGoals());
      
      // Auto-sync from cloud every 60 seconds
      setInterval(async () => {
        const owner = localStorage.getItem('gh-owner');
        const repo = localStorage.getItem('gh-repo');
        const token = localStorage.getItem('gh-token');
        if (owner && repo && token && navigator.onLine) {
          await loadFromCloud();
        }
      }, 60000);
      
      // Sync when coming back online or when page becomes visible
      window.addEventListener('online', () => {
        const owner = localStorage.getItem('gh-owner');
        const repo = localStorage.getItem('gh-repo');
        const token = localStorage.getItem('gh-token');
        if (owner && repo && token) {
          loadFromCloud();
        }
      });
      
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          const owner = localStorage.getItem('gh-owner');
          const repo = localStorage.getItem('gh-repo');
          const token = localStorage.getItem('gh-token');
          if (owner && repo && token) {
            loadFromCloud();
          }
        }
      });
    });
  </script>
</body>
</html>
